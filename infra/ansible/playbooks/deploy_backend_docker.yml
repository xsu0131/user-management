---
- name: Deploy Spring Boot Docker Container
  hosts: backend
  become: yes

  vars:
    database_ip: "{{ groups['database'][0] }}"

  tasks:
    - name: Pull latest image
      shell: docker pull xsu0131/user-management-backend:latest

    - name: Stop existing container
      shell: docker stop backend-app || true

    - name: Remove existing container
      shell: docker rm backend-app || true

    - name: Run new container
      shell: |
        docker run -d \
          --name backend-app \
          --restart always \
          -p 8080:8080 \
          -e SPRING_DATASOURCE_URL=jdbc:mysql://{{ database_ip }}:3306/user_management \
          -e SPRING_DATASOURCE_USERNAME=appuser \
          -e SPRING_DATASOURCE_PASSWORD=apppass \
          -e SPRING_JPA_HIBERNATE_DDL_AUTO=update \
          -e JWT_SECRET=dGhpc0lzQVZlcnlMb25nU2VjcmV0S2V5Rm9ySldUVG9rZW5HZW5lcmF0aW9uMTIzNDU2Nzg5MA== \
          -e JWT_EXPIRATION=86400000 \
          xsu0131/user-management-backend:latest

    - name: Wait for container to start
      wait_for:
        port: 8080
        delay: 10
        timeout: 60

    - name: Check container status
      shell: docker ps | grep backend-app
      register: container_status

    - name: Display status
      debug:
        msg: "{{ container_status.stdout }}"
